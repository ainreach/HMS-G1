<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scheduling - FIFTY 50 MEDTECHIE</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
  <!-- Top header: logo left, Patient right -->
  <header class="dash-topbar">
    <div class="topbar-inner">
      <button class="menu-btn" id="btnToggle" aria-label="Toggle menu"><i class="fa-solid fa-bars"></i></button>
      <div class="brand">
        <img src="../logo.png" alt="FIFTY 50 MEDTECHIE" />
        <div class="brand-text">
          <h2>FIFTY 50 MEDTECHIE</h2>
          <small>"Trust Us... If You’re Feeling Lucky."</small>
        </div>
      </div>
      <div class="top-right">
        <select id="roleSel" title="Role"></select>
        <select id="branchSel" title="Branch"></select>
        <span class="role"><i class="fa-regular fa-user"></i> <span id="roleText">Role</span></span>
        <span class="role" style="margin-left:8px;"><i class="fa-solid fa-code-branch"></i> <span id="branchText">Branch</span></span>
      </div>
    </div>
  </header>

  <!-- Sidebar Layout (unified) -->
  <div class="layout">
    <aside class="simple-sidebar" id="sidebar">
      <nav class="side-nav">
        <a href="dashboard.html" data-feature="dashboard">Dashboard</a>
        <a href="registration-records.html" data-feature="ehr">Registration & Records</a>
        <a href="scheduling.html" class="active" data-feature="scheduling">Scheduling</a>
        <a href="billing.html" data-feature="billing">Billing & Payment</a>
        <a href="laboratory.html" data-feature="laboratory">Laboratory & Diagnostic</a>
        <a href="pharmacy.html" data-feature="pharmacy">Pharmacy</a>
        <a href="reports.html" data-feature="reports">Reports & Analytics</a>
      </nav>
    </aside>

    <main class="content">
      <h1 class="page-title">Scheduling</h1>

      <!-- Quick actions -->
      <section class="actions">
        <button class="action-btn" id="btnNew"><i class="fa-solid fa-calendar-plus"></i> New Appointment</button>
        <button class="action-btn" id="btnToday"><i class="fa-solid fa-calendar-day"></i> Today</button>
        <button class="action-btn" id="btnThisWeek"><i class="fa-solid fa-calendar-week"></i> This Week</button>
        <button class="action-btn" id="btnClear"><i class="fa-solid fa-broom"></i> Clear Demo Data</button>
      </section>

      <!-- Appointment Form -->
      <section class="form-container" id="formCard" style="display:none;">
        <h2><i class="fa-solid fa-clock"></i> Book Appointment</h2>
        <div class="row">
          <div>
            <label for="patient">Patient Name</label>
            <input id="patient" type="text" placeholder="e.g., Juan Dela Cruz">
          </div>
          <div>
            <label for="doctor">Doctor</label>
            <select id="doctor"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="date">Date</label>
            <input id="date" type="date">
          </div>
          <div>
            <label for="time">Time</label>
            <input id="time" type="time">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="duration">Duration (minutes)</label>
            <select id="duration">
              <option value="15">15</option>
              <option value="30" selected>30</option>
              <option value="45">45</option>
              <option value="60">60</option>
            </select>
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status">
              <option>Scheduled</option>
              <option>Confirmed</option>
              <option>Completed</option>
              <option>Cancelled</option>
              <option>No-Show</option>
            </select>
          </div>
        </div>
        <label for="reason">Reason / Notes</label>
        <input id="reason" type="text" placeholder="e.g., Follow-up checkup">
        <div style="margin-top: 12px; display: flex; gap: 8px;">
          <button class="submit-btn" id="btnSave">Save</button>
          <button class="btn-view" id="btnCancel" type="button">Cancel</button>
        </div>
      </section>

      <!-- Filters -->
      <section class="form-container">
        <h3><i class="fa-solid fa-filter"></i> Filters</h3>
        <div class="row">
          <div>
            <label for="filterDate">Date</label>
            <input id="filterDate" type="date">
          </div>
          <div>
            <label for="filterDoctor">Doctor</label>
            <input id="filterDoctor" type="text" placeholder="All">
          </div>
        </div>
      </section>

      <!-- Appointments List -->
      <section class="form-container">
        <h3><i class="fa-solid fa-calendar-check"></i> Upcoming Appointments</h3>
        <div id="apptList"></div>
      </section>
    </main>
  </div>

  <script src="rbac.js"></script>
  <script>
    // Sidebar collapse toggle
    const btn = document.getElementById('btnToggle');
    const sidebar = document.getElementById('sidebar');
    if (btn && sidebar) {
      btn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
    }

    // Simple localStorage-backed demo store
    const KEY = 'hms_appointments';
    const appts = {
      all: () => JSON.parse(localStorage.getItem(KEY) || '[]'),
      saveAll: (arr) => localStorage.setItem(KEY, JSON.stringify(arr)),
      add: (item) => { const a = appts.all(); a.push(item); appts.saveAll(a); },
      update: (id, patch) => { const a = appts.all().map(x => x.id===id? { ...x, ...patch }: x); appts.saveAll(a); },
      remove: (id) => { const a = appts.all().filter(x => x.id !== id); appts.saveAll(a); },
    };

    // Elements
    const formCard = document.getElementById('formCard');
    const patient = document.getElementById('patient');
    const doctor = document.getElementById('doctor');
    const date = document.getElementById('date');
    const time = document.getElementById('time');
    const duration = document.getElementById('duration');
    const status = document.getElementById('status');
    const reason = document.getElementById('reason');
    const apptList = document.getElementById('apptList');
    const filterDate = document.getElementById('filterDate');
    const filterDoctor = document.getElementById('filterDoctor');

    // Buttons
    document.getElementById('btnNew').onclick = () => { formCard.style.display = 'block'; };
    document.getElementById('btnCancel').onclick = () => { formCard.style.display = 'none'; clearForm(); };
    document.getElementById('btnClear').onclick = () => { localStorage.removeItem(KEY); render(); };
    document.getElementById('btnToday').onclick = () => { filterDate.valueAsDate = new Date(); render(); };
    document.getElementById('btnThisWeek').onclick = () => {
      // Set filter date to today to roughly show this week (client-side filter keeps all >= day start)
      filterDate.valueAsDate = new Date(); render();
    };

    // Editing state
    let editingId = null;

    document.getElementById('btnSave').onclick = () => {
      if (!patient.value || !doctor.value || !date.value || !time.value) {
        alert('Please complete all fields.');
        return;
      }
      const id = editingId || ('A' + Math.random().toString(36).slice(2, 8).toUpperCase());
      const start = new Date(date.value + 'T' + time.value);
      const dur = Number(duration.value || 30);
      const end = new Date(start.getTime() + dur*60000);

      // Conflict check: same doctor overlapping time
      const all = appts.all().filter(a => a.id !== id);
      const conflict = all.some(a => a.doctor === doctor.value && overlap(start, end, new Date(a.when), new Date(new Date(a.when).getTime() + (Number(a.duration||30))*60000)) && a.status !== 'Cancelled');
      if (conflict) {
        alert('Conflict: Selected doctor already has an appointment during this time.');
        return;
      }

      const item = { id, patient: patient.value, doctor: doctor.value, reason: reason.value, when: start.toISOString(), duration: dur, status: status.value };
      if (editingId) { appts.update(id, item); } else { appts.add(item); }
      formCard.style.display = 'none';
      clearForm();
      editingId = null;
      render();
    };

    filterDate.onchange = render;
    filterDoctor.oninput = render;

    function clearForm() {
      patient.value = '';
      doctor.value = '';
      date.value = '';
      time.value = '';
      reason.value = '';
      duration.value = '30';
      status.value = 'Scheduled';
    }

    function formatDate(dt) {
      return dt.toLocaleString([], { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function render() {
      const all = appts.all().sort((a,b) => new Date(a.when) - new Date(b.when));
      const dFilter = filterDate.value ? new Date(filterDate.value) : null;
      const drFilter = (filterDoctor.value || '').trim().toLowerCase();

      const list = all.filter(a => {
        const dt = new Date(a.when);
        const dateOk = !dFilter || dt.toDateString() === dFilter.toDateString();
        const docOk = !drFilter || a.doctor.toLowerCase().includes(drFilter);
        return dateOk && docOk;
      });

      if (!list.length) {
        apptList.innerHTML = '<p class="muted">No appointments found.</p>';
        return;
      }

      apptList.innerHTML = list.map(a => {
        const dt = new Date(a.when);
        const badge = a.status ? `<span class="low" style="background:#e0e7ff;color:#3730a3;">${a.status}</span>` : '';
        return `
          <div class="record">
            <p><strong>${a.patient}</strong> with <strong>${a.doctor}</strong><br>
            <span class="muted">${formatDate(dt)} · ${a.duration||30} mins</span></p>
            <div class="actions">
              ${badge}
              <button class="btn-view" onclick="alert('Notes: ${a.reason ? a.reason.replace(/\"/g,'&quot;') : 'N/A'}')">Notes</button>
              <button class="btn-view" onclick="(function(id){ const a = (${appts.all.toString()})().find(x=>x.id===id); if(!a) return; (${openForEdit.toString()})(a); })('${a.id}')">Edit</button>
              <button class="btn-danger" onclick="(function(id){ const ok = confirm('Cancel this appointment?'); if(ok){ (${appts.remove.toString()})(id); render(); } })('${a.id}')">Cancel</button>
            </div>
          </div>`;
      }).join('');
    }

    function overlap(s1,e1,s2,e2){ return s1 < e2 && s2 < e1; }

    function openForEdit(a){
      formCard.style.display = 'block';
      editingId = a.id;
      patient.value = a.patient || '';
      doctor.value = a.doctor || '';
      const dt = new Date(a.when);
      date.value = dt.toISOString().slice(0,10);
      time.value = dt.toTimeString().slice(0,5);
      duration.value = String(a.duration || 30);
      status.value = a.status || 'Scheduled';
      reason.value = a.reason || '';
    }

    // Seed demo data if empty
    (function seed(){
      // Seed doctors roster if empty
      const DKEY = 'hms_doctors';
      if (!localStorage.getItem(DKEY)) {
        const docs = ['Dr. Santos','Dr. Reyes','Dr. Lee','Dr. Cruz'];
        localStorage.setItem(DKEY, JSON.stringify(docs));
      }
      // Populate doctor select
      const docs = JSON.parse(localStorage.getItem('hms_doctors')||'[]');
      doctor.innerHTML = docs.map(d=>`<option value="${d}">${d}</option>`).join('');

      if (appts.all().length) { render(); return; }
      const now = new Date();
      const sample = [
        { patient: 'Juan Dela Cruz', doctor: 'Dr. Santos', reason: 'Follow-up', when: new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0).toISOString(), duration: 30, status: 'Scheduled' },
        { patient: 'Maria Clara', doctor: 'Dr. Reyes', reason: 'Consultation', when: new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 14, 30).toISOString(), duration: 30, status: 'Confirmed' }
      ];
      appts.saveAll(sample.map((x,i) => ({ id: 'A' + (100+i), ...x })));
      render();
    })();
  </script>
</body>
</html>
